# ==========================================
# 5. PREDICTION LOGIC (Updated with "Why")
# ==========================================

if predict_btn:
    
    # A. Run Animation
    with st.spinner("Analyzing Logistics Route..."):
        step_size = 1 
        for i in range(0, len(path_points), step_size):
            current_pos = pd.DataFrame([{"lon": path_points[i][0], "lat": path_points[i][1]}])
            map_placeholder.pydeck_chart(render_map(current_pos))
            time.sleep(0.02)
        final_pos = pd.DataFrame([{"lon": dest_coords["lon"], "lat": dest_coords["lat"]}])
        map_placeholder.pydeck_chart(render_map(final_pos))

    # B. Prepare Payload
    input_data = {
        "columns": [
            "Carrier", "Origin_Warehouse", "Destination", "Shipment_Month", 
            "Distance_miles", "Weight_kg", "Cost", "Status", "Delivery_Date" 
        ],
        "data": [[
            courier, origin_name, dest_name, "December", real_distance, 
            weight, cost, "On Time", str(delivery_date)
        ]]
    }
    
    # C. Call API
    prediction = get_prediction(input_data)
    
    # D. Display Results
    if isinstance(prediction, (int, float)):
        st.success("Prediction Complete!")
        
        predicted_days = float(prediction)
        final_arrival = delivery_date + datetime.timedelta(days=int(predicted_days))
        
        # 1. METRICS
        m1, m2 = st.columns(2)
        with m1:
            st.metric(label="‚è±Ô∏è Transit Time", value=f"{predicted_days:.1f} Days", delta="AI Predicted")
        with m2:
            st.metric(label="üìÖ Arrival Date", value=str(final_arrival))
            
        # 2. EXPLANATION ("Why did I get this number?")
        st.markdown("---")
        st.subheader("üß† Model Explainability")
        
        # We construct a dynamic explanation based on the Champion Model (Lasso) logic
        insight_msg = f"""
        **Why this result?**
        Your prediction was generated by a **Lasso Regression model** (RMSE ~0.96). 
        
        * **Primary Driver:** The most significant factor increasing your transit time is the **Distance of {real_distance} miles**. The model found a strong linear correlation between flight path length and duration.
        * **Secondary Factor:** The choice of **{courier}** adjusts the baseline speed based on historical performance data for this carrier.
        * **Minor Factors:** While **Weight ({weight} kg)** affects the cost significantly, the model determined it has a minimal impact on flight speed compared to distance.
        """
        
        st.info(insight_msg, icon="‚ÑπÔ∏è")
        
    else:
        st.error(prediction)
